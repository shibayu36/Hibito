# リセット時刻カスタマイズ機能 設計書

## 1. 概要

現在の仕様では毎日ローカルタイムの0時にタスクが自動削除されるが、これをユーザーが設定できるようにする。
設定は時間単位（0〜23時）でシンプルに実装する。

## 2. 機能要件

### 2.1 基本仕様
- **設定可能範囲**: 0〜23時（時間単位のみ、分は設定不可）
- **デフォルト値**: 0時
- **動作**: 設定された時刻になったら前回リセット時刻以前のタスクを削除

### 2.2 ユーザー体験
- ContentView内の歯車アイコンから設定画面を表示
- Pickerで時刻を選択するシンプルなUI
- 設定変更後は即座に反映

## 3. 技術設計

### 3.1 設定データの管理

**UserDefaultsを使用**
- キー: `"resetHour"`
- 型: Int (0-23)
- デフォルト値: 0

### 3.2 設定値管理

**SettingsRepository**: 設定情報の永続化とアクセスを管理

```swift
class SettingsRepository {
    private let userDefaults = UserDefaults.standard
    private let resetHourKey = "resetHour"
    
    var resetHour: Int {
        get {
            userDefaults.integer(forKey: resetHourKey)
        }
        set {
            userDefaults.set(newValue, forKey: resetHourKey)
        }
    }
    
    // シングルトンパターン
    static let shared = SettingsRepository()
    private init() {}
}
```

**設定のObservableObject（UI用）**:

```swift
class SettingsViewModel: ObservableObject {
    private let repository = SettingsRepository.shared
    
    @Published var resetHour: Int {
        didSet {
            repository.resetHour = resetHour
        }
    }
    
    init() {
        resetHour = repository.resetHour
    }
}
```

### 3.3 リセット判定ロジックの変更

現在の`isBeforeToday()`を拡張して、設定時刻を基準にした判定に変更：

```swift
extension Date {
    // 設定されたリセット時刻より前かどうかを判定
    func isBeforeResetTime(hour: Int) -> Bool {
        let calendar = Calendar.current
        let now = Date()
        
        // 今日のリセット時刻を計算（分は0固定）
        var todayResetComponents = calendar.dateComponents([.year, .month, .day], from: now)
        todayResetComponents.hour = hour
        todayResetComponents.minute = 0
        let todayResetTime = calendar.date(from: todayResetComponents)!
        
        // 現在時刻がリセット時刻を過ぎているか
        if now >= todayResetTime {
            // 過ぎている場合：今日のリセット時刻より前のタスクが削除対象
            return self < todayResetTime
        } else {
            // 過ぎていない場合：昨日のリセット時刻より前のタスクが削除対象
            let yesterdayResetTime = calendar.date(byAdding: .day, value: -1, to: todayResetTime)!
            return self < yesterdayResetTime
        }
    }
}
```

### 3.4 AutoResetServiceの更新

```swift
@MainActor
static func checkAndPerformReset(context: ModelContext) -> Bool {
    let resetHour = SettingsRepository.shared.resetHour
    
    let descriptor = FetchDescriptor<TodoItem>()
    guard let allItems = try? context.fetch(descriptor) else {
        return false
    }
    
    // 設定時刻より前に作成されたタスクを特定
    let tasksToDelete = allItems.filter { item in
        item.createdAt.isBeforeResetTime(hour: resetHour)
    }
    
    // 以下同じ...
}
```

## 4. UI設計

### 4.1 設定UI
- ContentView内にシートとして表示
- デバッグメニューの隣に歯車アイコンを配置
- タップでシート表示

### 4.2 設定画面の構成
```swift
VStack {
    Text("毎日のリセット時刻")
        .font(.headline)
    
    Picker("リセット時刻", selection: $settingsViewModel.resetHour) {
        ForEach(0..<24) { hour in
            Text("\(hour)時").tag(hour)
        }
    }
    .pickerStyle(.wheel)
    
    Button("完了") {
        dismiss()
    }
}
```

## 5. 実装手順

1. **SettingsRepository作成**
   - `Hibito/Repositories/SettingsRepository.swift`として実装
   - シングルトンパターンでUserDefaultsアクセスを管理
   - 設定値の永続化を担当

2. **SettingsViewModel作成**
   - `Hibito/ViewModels/SettingsViewModel.swift`として実装
   - ObservableObjectでSwiftUI連携
   - RepositoryとUIの橋渡し役

3. **Date+Extensions更新**
   - `isBeforeResetTime(hour:)`メソッドを追加
   - 既存の`isBeforeToday()`は互換性のため残す

4. **AutoResetService更新**
   - SettingsRepository.sharedから設定値を取得
   - 新しい判定メソッドを使用するよう修正

5. **ContentView更新**
   - @StateObject private var settingsViewModelを追加
   - 歯車アイコンと設定シートを追加
   - 設定変更時に即座にリセットチェックを実行

6. **テスト更新**
   - DateExtensionsTestsに新しいテストケース追加
   - AutoResetServiceTestsに設定時刻のテスト追加
   - SettingsRepositoryTestsを作成

## 6. 考慮事項

### 6.1 初回起動時
- UserDefaultsに値がない場合は0時がデフォルト
- integer(forKey:)は値がない場合0を返すので追加処理不要

### 6.2 設定変更時の動作
- 設定変更後、即座にcheckAndPerformResetを実行
- ユーザーに視覚的フィードバックを提供

### 6.3 タイムゾーン
- 常にローカルタイムゾーンで動作
- タイムゾーン変更時も自動的に対応

### 6.4 既存機能との互換性
- isBeforeToday()は残すが、内部的にisBeforeResetTime(hour: 0)を呼ぶ

## 7. テスト戦略

### 7.1 単体テスト
- isBeforeResetTime()の境界条件テスト
- 様々な設定時刻（0時、12時、23時など）でのテスト
- 日付を跨ぐケースのテスト
- SettingsRepositoryの読み書きテスト

### 7.2 統合テスト
- SettingsViewModelとRepositoryの連携テスト
- AutoResetServiceの設定時刻対応テスト

### 7.3 手動テスト
- 設定画面のUI動作確認
- 時刻変更後の即時リセット動作確認
- iOS SimulatorでのdebugメニューからのシミュレーションDate変更テスト