# 日次リセット機能 設計書

## 1. 概要

毎日0時に全タスクが自動的に消去される機能の実装設計。
Hibitoのコアコンセプトである「今日のやる気を上げるためだけのTODOアプリ」を実現する最重要機能。

## 2. 機能要件

### 2.1 基本仕様
- **リセット時刻**: デバイスのローカル時刻 0:00:00
- **対象タスク**: 完了/未完了問わず全タスク
- **動作環境**: アプリが起動中/バックグラウンド/未起動すべての状態で機能

### 2.2 ユーザー体験
- リセット時に視覚的フィードバック（アニメーション）
- アプリ起動時に前日のタスクが既に消えている状態

## 3. 技術設計

### 3.1 前提条件
- SwiftDataによるデータ永続化が実装済みであること
- TodoItemモデルがModelContainerに登録されていること

### 3.2 実装アプローチ（2段階チェック）

#### 段階1: アプリ起動時チェック
```swift
// HibitoApp.swift または ContentView.swift の onAppear
1. UserDefaultsから lastResetDate を取得
2. 現在日時と比較（日付が変わっているか）
3. 日付が変わっていたら全タスク削除
4. lastResetDate を更新
```

#### 段階2: アプリ実行中の監視
```swift
// TodoViewModel.swift
1. Timer.scheduledTimer で毎分チェック
2. 現在時刻が 00:00-00:01 の範囲内かチェック
3. かつ本日まだリセットしていない場合のみ実行
4. リセット実行後、lastResetDate を更新
```

### 3.3 データモデル設計

#### UserDefaults キー
```swift
enum UserDefaultsKeys {
    static let lastResetDate = "lastResetDate"
}
```

#### リセット管理
```swift
struct ResetManager {
    static func shouldReset() -> Bool
    static func performReset()
    static func updateLastResetDate()
}
```

### 3.4 実装詳細

#### 日付判定ロジック
```swift
extension Date {
    func isNewDay(comparedTo lastReset: Date?) -> Bool {
        guard let lastReset = lastReset else { return true }
        let calendar = Calendar.current
        return !calendar.isDate(self, inSameDayAs: lastReset)
    }
}
```

#### Timer設定
- 間隔: 60秒（1分）
- tolerance: 10秒（バッテリー効率考慮）
- RunLoop: .main

#### リセット処理フロー
1. SwiftDataコンテキストから全TodoItem取得
2. バッチ削除実行
3. UIアニメーション開始（フェードアウト）
4. lastResetDate更新
5. 完了後の空リスト表示

### 3.5 アニメーション仕様

#### リセット時のビジュアル効果
```swift
// 全タスクが同時にフェードアウト
.transition(.opacity.combined(with: .scale))
.animation(.easeOut(duration: 0.5))
```

#### 新しい日の演出
- 背景色が一瞬明るくなる「フラッシュ効果」
- "新しい一日が始まりました"のメッセージ表示（2秒後に自動消去）

## 4. エッジケース対応

### 4.1 時刻関連
- **23:59:59のタスク追加**: 追加は許可、1秒後に削除
- **タイムゾーン変更**: 新タイムゾーンの0時に合わせて動作
- **サマータイム**: システムのCalendarに従う

### 4.2 アプリ状態
- **バックグラウンド制限**: 次回起動時にチェック＆リセット
- **強制終了からの復帰**: onAppearでの確実なチェック
- **日付を跨いだ長時間未起動**: 起動時に適切にリセット

### 4.3 データ整合性
- **リセット中のクラッシュ**: 次回起動時に再度チェック
- **同期競合**: ローカルリセットを優先

## 5. テスト戦略

### 5.1 単体テスト
- ResetManagerの日付判定ロジック
- 日付を跨ぐケースのシミュレーション

### 5.2 統合テスト
- Timer動作の確認
- SwiftDataとの連携確認

### 5.3 手動テスト
- デバイス時刻を23:59に設定して動作確認
- バックグラウンドからの復帰テスト

## 6. 実装順序

1. **SwiftData永続化** - 前提条件として必須
2. **基本リセット機能** - 起動時チェックから実装
3. **Timer監視** - アプリ実行中の自動リセット
4. **アニメーション** - UX向上のための視覚効果
5. **エッジケース対応** - 各種異常系の処理

## 7. 将来の拡張可能性

- リセット時刻のカスタマイズ（例: 朝5時リセット）
- 特定タスクの翌日持ち越し機能（要検討）
- リセット履歴の統計機能