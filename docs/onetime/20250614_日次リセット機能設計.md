# 日次リセット機能 設計書

## 1. 概要

毎日0時に全タスクが自動的に消去される機能の実装設計。
Hibitoのコアコンセプトである「今日のやる気を上げるためだけのTODOアプリ」を実現する最重要機能。

## 2. 機能要件

### 2.1 基本仕様
- **リセット時刻**: デバイスのローカル時刻で日付が変わった時点
- **対象タスク**: 完了/未完了問わず全タスク
- **動作タイミング**: 
  - アプリ起動時
  - アプリがアクティブになった時（バックグラウンドから復帰）
  - アプリ実行中（Timer監視）

### 2.2 ユーザー体験
- リセット時に視覚的フィードバック（アニメーション）
- アプリ起動時に前日のタスクが既に消えている状態

## 3. 技術設計

### 3.1 前提条件
- SwiftDataによるデータ永続化が実装済みであること
- TodoItemモデルがModelContainerに登録されていること

### 3.2 実装アプローチ（3つのトリガー）

#### トリガー1: アプリ起動時チェック
```swift
// HibitoApp.swift または ContentView.swift の onAppear
1. SwiftDataから全TodoItemを取得
2. 各TodoItemのcreatedAtを確認
3. 昨日以前に作成されたタスクを削除
```

#### トリガー2: アプリアクティブ時チェック
```swift
// SceneDelegate または NotificationCenter
1. UIApplication.didBecomeActiveNotification を監視
2. アクティブになった時に古いタスクをチェック
3. 必要に応じてリセット処理実行
```

#### トリガー3: アプリ実行中の監視
```swift
// TodoViewModel.swift
1. Timer.scheduledTimer で毎分チェック
2. 古いタスクがあれば削除
3. Timer動作中は重複実行を防ぐ
```

### 3.3 データモデル設計

#### TodoItem活用
```swift
// TodoItem.swift（既存）
@Model
class TodoItem {
    var createdAt = Date() // このフィールドを活用
    // その他のプロパティ...
}
```

#### リセット管理
```swift
struct ResetManager {
    static func performReset(context: ModelContext) {
        let calendar = Calendar.current
        let today = Date()
        
        // 昨日以前に作成されたタスクを削除
        let descriptor = FetchDescriptor<TodoItem>()
        let allItems = try? context.fetch(descriptor) ?? []
        
        let tasksToDelete = allItems.filter { item in
            item.createdAt.isBeforeToday()
        }
        
        tasksToDelete.forEach { context.delete($0) }
        try? context.save()
    }
}
```

### 3.4 実装詳細

#### 日付判定ロジック
```swift
extension Date {
    func isToday() -> Bool {
        let calendar = Calendar.current
        return calendar.isDateInToday(self)
    }
    
    func isBeforeToday() -> Bool {
        let calendar = Calendar.current
        let today = calendar.startOfDay(for: Date())
        let thisDate = calendar.startOfDay(for: self)
        return thisDate < today
    }
    
    func isSameDay(as otherDate: Date) -> Bool {
        let calendar = Calendar.current
        return calendar.isDate(self, inSameDayAs: otherDate)
    }
}
```

#### Timer設定
- 間隔: 60秒（1分）
- tolerance: 10秒（バッテリー効率考慮）
- RunLoop: .main

#### リセット処理フロー
1. SwiftDataコンテキストから全TodoItem取得
2. 昨日以前に作成されたタスクを特定
3. UIアニメーション開始（フェードアウト）
4. バッチ削除実行
5. 完了後のリスト表示（今日・明日のタスクは残る）

### 3.5 アニメーション仕様

#### リセット時のビジュアル効果
```swift
// 全タスクが同時にフェードアウト
.transition(.opacity.combined(with: .scale))
.animation(.easeOut(duration: 0.5))
```

#### 新しい日の演出
- 背景色が一瞬明るくなる「フラッシュ効果」

## 4. エッジケース対応

### 4.1 時刻関連
- **23:59:59のタスク追加**: 追加は許可、1秒後に削除
- **タイムゾーン変更**: 新タイムゾーンの0時に合わせて動作
- **サマータイム**: システムのCalendarに従う

### 4.2 アプリ状態
- **アプリ切り替え**: didBecomeActiveNotificationでのチェック＆リセット
- **強制終了からの復帰**: onAppearでの確実なチェック
- **日付を跨いだ長時間未起動**: 起動時に適切にリセット

### 4.3 データ整合性
- **リセット中のクラッシュ**: 次回起動時に再度チェック
- **同期競合**: ローカルリセットを優先

## 5. テスト戦略

### 5.1 単体テスト
- ResetManagerの日付判定ロジック
- 日付を跨ぐケースのシミュレーション

### 5.2 統合テスト
- Timer動作の確認
- SwiftDataとの連携確認

### 5.3 手動テスト
- デバイス時刻を23:59に設定して動作確認
- アプリ切り替え（ホーム画面に出てからアプリに戻る）テスト
- アプリ強制終了からの復帰テスト

## 6. 実装順序

1. **SwiftData永続化** - 前提条件として必須
2. **基本リセット機能** - 起動時チェックから実装
3. **Timer監視** - アプリ実行中の自動リセット
4. **アニメーション** - UX向上のための視覚効果
5. **エッジケース対応** - 各種異常系の処理

## 7. 将来の拡張可能性

- **明日のタスク入力機能**: 今回の設計変更により実装可能
- リセット時刻のカスタマイズ（例: 朝5時リセット）
- 特定タスクの翌日持ち越し機能
- リセット履歴の統計機能

### 7.1 明日のタスク機能の実装案
```swift
// TodoItem に scheduledDate フィールドを追加
@Model
class TodoItem {
    var scheduledDate = Date() // いつのタスクか（デフォルトは今日）
    var createdAt = Date()     // いつ作成されたか
    // その他のプロパティ...
}

// 表示時のフィルタリング
func tasksForToday() -> [TodoItem] {
    return todoItems.filter { $0.scheduledDate.isToday() }
}
```
