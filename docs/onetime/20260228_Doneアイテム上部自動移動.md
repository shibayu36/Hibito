# 要件定義書：DoneアイテムのTODOリスト上部自動移動

## Context / Goal

**Context**: 現在のHibitoアプリでは、TODOアイテムをDoneにしても表示位置は変わらない。完了済みアイテムは取り消し線と色変更で視覚的に区別されるのみ。

**Goal**: Doneにしたアイテムを自動的にリストの上部に移動させることで、「今日やったこと」が一目で確認でき、達成感を得やすいUIを実現する。

## In Scope

- Doneにしたアイテムがリスト上部に自動的に表示される（アニメーション付き）
- 完了アイテム同士は元の並び順を維持する
- 未完了アイテム同士も元の並び順を維持する
- Done解除時はorder値に基づき、大体元の位置に戻る
- 完了/未完了グループ間のセパレーターは表示しない（取り消し線で十分区別可能）
- ドラッグ&ドロップは未完了アイテムのみ可能とし、完了アイテムのドラッグは無効化する

## Out of Scope

- 完了アイテムと未完了アイテムの間のセパレーター/セクション見出し
- ソート順の切り替えオプション（設定画面での選択肢など）
- 完了アイテムを非表示にする機能
- 完了アイテムの折りたたみ機能
- 完了アイテム同士のドラッグ&ドロップ並び替え

## User Stories

1. **ユーザーとして**、TODOをDoneにしたとき、そのアイテムがアニメーション付きでリストの上部に移動するのを見たい。**それにより**、達成した項目がまとまって見え、達成感が得られる。

2. **ユーザーとして**、複数のTODOをDoneにしたとき、完了アイテム同士は元の並び順のまま上部に表示されてほしい。**それにより**、完了済みタスクの順序が予測可能で混乱しない。

3. **ユーザーとして**、Doneを解除したとき、そのアイテムが未完了グループ内の大体元の位置に戻ってほしい。**それにより**、作業の流れが崩れない。

4. **ユーザーとして**、未完了のTODOアイテムをドラッグ&ドロップで並び替えたい。**それにより**、既存の手動並び替え機能がそのまま使える。

5. **ユーザーとして**、アプリ起動時にもDoneアイテムが上部に表示されてほしい。**それにより**、再起動後も一貫した表示が維持される。

## Acceptance Criteria（Gherkin）

### 主要シナリオ

**AC1: アイテムをDoneにすると上部にアニメーション付きで移動する**

```gherkin
Given 3つの未完了アイテム「A」「B」「C」が順に表示されている
When 「B」をDoneにする
Then 「B」がアニメーション付きでリスト上部に移動する
And リストの並びは「B（完了）」「A」「C」となる
```

**AC2: 複数アイテムをDoneにしたとき元の相対順序を維持する**

```gherkin
Given 4つの未完了アイテム「A」「B」「C」「D」が順に表示されている
When 「C」をDoneにし、次に「A」をDoneにする
Then リストの並びは「A（完了）」「C（完了）」「B」「D」となる
And 完了アイテム同士は元のorder値の順序を維持する
```

**AC3: Doneを解除すると大体元の位置に戻る**

```gherkin
Given アイテム「A（完了）」「C（完了）」「B」「D」が表示されている
When 「C」のDoneを解除する
Then 「C」は未完了グループ内で元のorder値に基づいた位置に表示される
And リストの並びは「A（完了）」「B」「C」「D」となる
```

### 例外シナリオ

**AC4: 完了アイテムはドラッグ&ドロップで並び替えできない**

```gherkin
Given 完了アイテム「A（完了）」と未完了アイテム「B」「C」が表示されている
When 「A（完了）」をドラッグしようとする
Then ドラッグ操作は無効化されている
And 未完了アイテム「B」「C」はドラッグ&ドロップで並び替え可能
```

**AC5: 全アイテムがDoneまたは0〜1件の場合**

```gherkin
Given 3つの未完了アイテム「A」「B」「C」が順に表示されている
When すべてのアイテムをDoneにする
Then リストの並びは「A（完了）」「B（完了）」「C（完了）」となる
And 元の相対順序が維持される
```

## NFR（非機能要件）

| 観点 | 要件 |
|------|------|
| **パフォーマンス** | ソート処理はアイテム数が数十件の範囲で体感遅延なく完了すること（日次リセットの特性上、大量データは想定不要） |
| **アニメーション** | SwiftUI標準アニメーションを使用し、アイテムが上部に移動する動きをユーザーに見せること |
| **一貫性** | アプリ再起動後もソート順が同一であること |
| **iCloud同期** | 複数端末間でも同一のソート順で表示されること（order値を変更しないため既存の同期に影響なし） |
| **既存機能への影響** | 未完了アイテムのドラッグ&ドロップによる手動並び替えが引き続き正常に動作すること |

## Open Questions

なし（すべて解決済み）

## 実装計画

### 設計方針
- **表示ソート順の変更のみ（order値は変更しない）** アプローチを採用
- FetchDescriptorのソート順に `isCompleted` 降順を追加し、完了アイテムを上部に表示
- order値を変更しないことで、iCloud同期への影響なし＆Done解除時に自然に元の位置へ復帰

### フェーズ1: DoneアイテムのTODOリスト上部自動移動（1PR）

#### Commit 1: Doneアイテムをリスト上部に自動移動し、完了アイテムのドラッグを無効化する
- `loadTodos()` のFetchDescriptorに `SortDescriptor(\.isCompleted, order: .reverse)` を先頭に追加
- View側のtoggleCompletionアクションを `withAnimation` でラップ
- View側に `.moveDisabled(item.isCompleted)` を追加
- `moveTodo()` に完了アイテムのドラッグガード追加（`guard !movingItem.isCompleted`）
- `moveTodo()` に移動先を未完了アイテム範囲に制限するガード追加
- テスト追加：ソート順、ドラッグ制御のテスト
