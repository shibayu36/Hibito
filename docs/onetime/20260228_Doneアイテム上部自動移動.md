# 要件定義書：DoneアイテムのTODOリスト上部自動移動

## Context / Goal

**Context**: 現在のHibitoアプリでは、TODOアイテムをDoneにしても表示位置は変わらない。完了済みアイテムは取り消し線と色変更で視覚的に区別されるのみ。

**Goal**: Doneにしたアイテムを自動的にリストの上部に移動させることで、「今日やったこと」が一目で確認でき、達成感を得やすいUIを実現する。

## In Scope

- Doneにしたアイテムがリスト上部に自動的に表示される（アニメーション付き）
- Doneにしたアイテムは完了グループの末尾に追加される（Doneにした順に下に積まれる）
- 未完了アイテム同士も元の並び順を維持する
- Done解除時は未完了グループの先頭に配置される
- 完了/未完了グループ間のセパレーターは表示しない（取り消し線で十分区別可能）
- ドラッグ&ドロップは未完了アイテムのみ可能とし、完了アイテムのドラッグは無効化する

## Out of Scope

- 完了アイテムと未完了アイテムの間のセパレーター/セクション見出し
- ソート順の切り替えオプション（設定画面での選択肢など）
- 完了アイテムを非表示にする機能
- 完了アイテムの折りたたみ機能
- 完了アイテム同士のドラッグ&ドロップ並び替え

## User Stories

1. **ユーザーとして**、TODOをDoneにしたとき、そのアイテムがアニメーション付きでリストの上部（完了グループの末尾）に移動するのを見たい。**それにより**、達成した項目がまとまって見え、達成感が得られる。

2. **ユーザーとして**、複数のTODOをDoneにしたとき、Doneにした順に完了グループの末尾に追加されてほしい。**それにより**、完了した順番が直感的にわかる。

3. **ユーザーとして**、Doneを解除したとき、そのアイテムが未完了グループの先頭に配置されてほしい。**それにより**、すぐに目に入り作業を再開しやすい。

4. **ユーザーとして**、未完了のTODOアイテムをドラッグ&ドロップで並び替えたい。**それにより**、既存の手動並び替え機能がそのまま使える。

5. **ユーザーとして**、アプリ起動時にもDoneアイテムが上部に表示されてほしい。**それにより**、再起動後も一貫した表示が維持される。

## Acceptance Criteria（Gherkin）

### 主要シナリオ

**AC1: アイテムをDoneにすると完了グループの末尾にアニメーション付きで移動する**

```gherkin
Given 3つの未完了アイテム「A」「B」「C」が順に表示されている
When 「B」をDoneにする
Then 「B」がアニメーション付きでリスト上部に移動する
And リストの並びは「B（完了）」「A」「C」となる
```

**AC2: 複数アイテムをDoneにしたときDoneにした順に末尾に追加される**

```gherkin
Given 4つの未完了アイテム「A」「B」「C」「D」が順に表示されている
When 「C」をDoneにし、次に「A」をDoneにする
Then リストの並びは「C（完了）」「A（完了）」「B」「D」となる
And 完了アイテム同士はDoneにした順序で表示される
```

**AC3: Doneを解除すると未完了グループの先頭に配置される**

```gherkin
Given アイテム「C（完了）」「A（完了）」「B」「D」が表示されている
When 「C」のDoneを解除する
Then 「C」は未完了グループの先頭に配置される
And リストの並びは「A（完了）」「C」「B」「D」となる
```

### 例外シナリオ

**AC4: 完了アイテムはドラッグ&ドロップで並び替えできない**

```gherkin
Given 完了アイテム「A（完了）」と未完了アイテム「B」「C」が表示されている
When 「A（完了）」をドラッグしようとする
Then ドラッグ操作は無効化されている
And 未完了アイテム「B」「C」はドラッグ&ドロップで並び替え可能
```

**AC5: 全アイテムを順にDoneにする場合**

```gherkin
Given 3つの未完了アイテム「A」「B」「C」が順に表示されている
When 「A」「B」「C」の順にすべてのアイテムをDoneにする
Then リストの並びは「A（完了）」「B（完了）」「C（完了）」となる
And Doneにした順序で表示される
```

## NFR（非機能要件）

| 観点 | 要件 |
|------|------|
| **パフォーマンス** | ソート処理はアイテム数が数十件の範囲で体感遅延なく完了すること（日次リセットの特性上、大量データは想定不要） |
| **アニメーション** | SwiftUI標準アニメーションを使用し、アイテムが上部に移動する動きをユーザーに見せること |
| **一貫性** | アプリ再起動後もソート順が同一であること |
| **iCloud同期** | 複数端末間でも同一のソート順で表示されること（order値の変更はSwiftDataの通常更新として同期される） |
| **既存機能への影響** | 未完了アイテムのドラッグ&ドロップによる手動並び替えが引き続き正常に動作すること |

## Open Questions

なし（すべて解決済み）

## 実装計画

### 設計方針
- **表示ソート順の変更 + toggleCompletion時のorder値調整** アプローチを採用
- loadTodosでVM側でfilter+結合し、完了アイテムを上部に表示
- toggleCompletion時にorder値を調整し、Done時は完了末尾、Done解除時は未完了先頭に配置

### フェーズ1: DoneアイテムのTODOリスト上部自動移動（1PR）

#### Commit 1: Doneアイテムをリスト上部に自動移動し、完了アイテムのドラッグを無効化する
- `loadTodos()` でVM側のfilter+結合により完了アイテムを上部に表示
- `toggleCompletion()` でorder値を調整（Done時は完了末尾、Done解除時は未完了先頭）
- View側のtoggleCompletionアクションを `withAnimation` でラップ
- View側に `.moveDisabled(item.isCompleted)` を追加
- `moveTodo()` に完了アイテムのドラッグガード追加（`guard !movingItem.isCompleted`）
- `moveTodo()` に移動先を未完了アイテム範囲に制限するガード追加
- テスト追加：ソート順、ドラッグ制御のテスト
