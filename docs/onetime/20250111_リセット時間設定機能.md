# リセット時間設定機能 要件定義

## 概要
現在0時固定となっているTODOリストの自動リセット時間を、ユーザーが1時間単位で設定できるようにする機能。

## 背景
- 現在のHibitoアプリは毎日0時に全タスクが自動的に削除される
- ユーザーによっては0時以外の時間（例：朝6時、夜9時など）にリセットしたい需要がある
- ユーザーのライフスタイルに合わせた柔軟な設定を可能にする

## 機能要件

### 1. 設定画面
- **アクセス方法**
  - TodoListViewのヘッダー部分に歯車アイコンを配置
  - タップするとNavigationLinkで設定画面へ遷移
  
- **設定項目**
  - リセット時間の選択
    - 24時間表記（0:00〜23:00）
    - 1時間刻みでの選択
    - デフォルト値：0:00（午前0時）
  
- **UI仕様**
  - Pickerを使用した時間選択
  - 選択後は自動的に保存される
  - 今後の拡張性を考慮したレイアウト（iCloud連携などの設定追加を想定）

### 2. リセット時間の動作
- 設定された時間になったら、その時間より前に作成されたタスクを削除
- 例：リセット時間が朝6:00の場合
  - 6:00になったら、6:00より前に作成されたタスクが削除対象
  - 5:59に作成したタスクは6:00に削除される
  - 6:01に作成したタスクは翌日の6:00まで残る

### 3. データ保存
- SwiftDataを使用して設定値を永続化
- アプリ再起動後も設定が維持される
- 既存のSwiftDataコンテナと統一されたデータ管理
- 将来のiCloud同期にも対応しやすい構造

## 技術設計

### アーキテクチャ
MVVMパターン + Repository パターンを採用
```
SettingsView → SettingsViewModel → SettingsRepository → SwiftData
```

### ディレクトリ構造
```
Hibito/
├── Repositories/
│   └── SettingsRepository.swift    # データアクセス層
├── ViewModels/
│   ├── TodoListViewModel.swift     # 既存
│   └── SettingsViewModel.swift     # 新規作成
├── Views/
│   ├── TodoListView.swift          # UI修正
│   └── SettingsView.swift          # 新規作成
├── Extensions/
│   └── Date+Extensions.swift       # 機能拡張
└── Models/
    ├── TodoItem.swift              # 変更なし
    └── Settings.swift              # 新規作成（@Modelマクロ使用）
```

### 実装コンポーネント

#### 1. Settings.swift（モデル）
```swift
import Foundation
import SwiftData

@Model
class Settings {
    var resetTime: Int
    
    init(resetTime: Int = 0) {
        self.resetTime = resetTime
    }
}
```

#### 2. SettingsRepository.swift
```swift
import Foundation
import SwiftData

class SettingsRepository {
    private let modelContext: ModelContext
    
    init(modelContext: ModelContext) {
        self.modelContext = modelContext
    }
    
    // 設定値を取得（存在しない場合はデフォルト値で新規作成）
    func getSettings() -> Settings {
        let descriptor = FetchDescriptor<Settings>()
        let settings = try? modelContext.fetch(descriptor).first
        
        if let existingSettings = settings {
            return existingSettings
        } else {
            // デフォルト設定を新規作成
            let newSettings = Settings(resetTime: 0)
            modelContext.insert(newSettings)
            try? modelContext.save()
            return newSettings
        }
    }
    
    // 設定値を更新
    func updateResetTime(_ resetTime: Int) {
        let settings = getSettings()
        settings.resetTime = resetTime
        try? modelContext.save()
    }
    
    // 今日の指定時刻のDateを取得
    func getResetDate() -> Date {
        let settings = getSettings()
        let calendar = Calendar.current
        let now = Date()
        return calendar.date(bySettingHour: settings.resetTime, minute: 0, second: 0, of: now) ?? now
    }
}
```

#### 3. SettingsViewModel.swift
```swift
import Foundation

@Observable
class SettingsViewModel {
    private let settingsRepository: SettingsRepository
    
    var resetTime: Int {
        get { settingsRepository.getSettings().resetTime }
        set { settingsRepository.updateResetTime(newValue) }
    }
    
    init(settingsRepository: SettingsRepository) {
        self.settingsRepository = settingsRepository
    }
    
    // 表示用の時間文字列を生成
    func formattedResetTime() -> String {
        return String(format: "%02d:00", resetTime)
    }
    
    // 設定の説明文を生成
    func resetTimeDescription() -> String {
        return "毎日\(formattedResetTime())に、それより前に作成されたタスクが自動的に削除されます"
    }
}
```

#### 4. SettingsView.swift
```swift
import SwiftUI
import SwiftData

struct SettingsView: View {
    @Environment(\.modelContext) private var modelContext
    @Environment(\.dismiss) private var dismiss
    @State private var viewModel: SettingsViewModel?
    
    var body: some View {
        NavigationStack {
            if let viewModel = viewModel {
                Form {
                    Section {
                        Picker("リセット時間", selection: $viewModel.resetTime) {
                            ForEach(0..<24, id: \.self) { hour in
                                Text(String(format: "%02d:00", hour)).tag(hour)
                            }
                        }
                        .pickerStyle(.wheel)
                    } header: {
                        Text("リセット時間")
                    } footer: {
                        Text(viewModel.resetTimeDescription())
                    }
                }
                .navigationTitle("設定")
                .navigationBarTitleDisplayMode(.inline)
                .toolbar {
                    ToolbarItem(placement: .navigationBarTrailing) {
                        Button("完了") {
                            dismiss()
                        }
                    }
                }
            }
        }
        .onAppear {
            let repository = SettingsRepository(modelContext: modelContext)
            viewModel = SettingsViewModel(settingsRepository: repository)
        }
    }
}
```

#### 5. Date+Extensions.swift への追加
```swift
extension Date {
    // 既存の isBeforeToday() はそのまま
    
    // 指定時刻より前に作成されたかを判定
    func isBeforeResetTime(_ resetTime: Int) -> Bool {
        let calendar = Calendar.current
        let now = Date()
        
        // 今日の指定時刻
        guard let todayResetTime = calendar.date(bySettingHour: resetTime, minute: 0, second: 0, of: now) else {
            return false
        }
        
        // 作成日時が今日の指定時刻より前で、かつ今の時刻が指定時刻を過ぎている場合
        if now >= todayResetTime {
            return self < todayResetTime
        }
        
        // まだ今日の指定時刻になっていない場合は、昨日の指定時刻と比較
        guard let yesterdayResetTime = calendar.date(byAdding: .day, value: -1, to: todayResetTime) else {
            return false
        }
        
        return self < yesterdayResetTime
    }
}
```

#### 6. TodoListView.swift への修正
```swift
// ツールバーに追加
.toolbar {
    ToolbarItem(placement: .navigationBarTrailing) {
        Button {
            showingSettings = true
        } label: {
            Image(systemName: "gear")
        }
    }
}
.sheet(isPresented: $showingSettings) {
    SettingsView()
}

// プロパティに追加
@State private var showingSettings = false
```

#### 7. TodoListViewModel.swift への修正
```swift
@Observable
class TodoListViewModel {
    private let modelContext: ModelContext
    private let settingsRepository: SettingsRepository
    
    // initの変更：SettingsRepositoryも受け取るように
    init(modelContext: ModelContext, settingsRepository: SettingsRepository) {
        self.modelContext = modelContext
        self.settingsRepository = settingsRepository
    }
    
    // 既存のコード...
    
    // performReset()を修正
    func performReset() {
        let allItems = loadAllTodos()
        let resetTime = settingsRepository.getSettings().resetTime
        
        let tasksToDelete = allItems.filter { item in
            item.createdAt.isBeforeResetTime(resetTime)
        }
        
        for task in tasksToDelete {
            modelContext.delete(task)
        }
        
        if !tasksToDelete.isEmpty {
            try? modelContext.save()
        }
    }
}
```

#### 8. TodoListView.swift でのViewModel初期化の修正
```swift
struct TodoListView: View {
    @Environment(\.modelContext) private var modelContext
    @State private var viewModel: TodoListViewModel?
    
    var body: some View {
        // 既存のUI実装...
    }
    
    .onAppear {
        if viewModel == nil {
            let settingsRepository = SettingsRepository(modelContext: modelContext)
            viewModel = TodoListViewModel(
                modelContext: modelContext,
                settingsRepository: settingsRepository
            )
        }
    }
}
```

### 実装順序

1. **Settings.swift**（モデル）の実装
2. **SettingsRepository.swift**の実装
3. **Date+Extensions**の拡張
4. **SettingsViewModel.swift**の実装
5. **SettingsView.swift**の実装
6. **TodoListView.swift**の修正（設定画面への遷移）
7. **TodoListViewModel.swift**の修正（Repository連携）
8. **ModelContainerManager.swift**の修正（Settingsモデル追加）
9. **テストの実装**
10. **動作確認**

### テスト設計

#### SettingsRepositoryTests.swift
- デフォルト値の確認
- SwiftDataへの保存確認
- getResetDate()の動作確認
- 複数回getSettings()を呼び出した時の一意性確認

#### SettingsViewModelTests.swift
- resetTimeのバインディング確認
- formattedResetTime()の動作確認
- resetTimeDescription()の動作確認
- MockRepositoryを使った分離テスト

#### Date+ExtensionsTests.swift への追加
- isBeforeResetTime()の各種時間パターンのテスト
- 日付変更をまたぐケースのテスト
- タイムゾーンの考慮

### データ反映の設計方針

**シンプルな反映戦略を採用：**
- 表示時にRepositoryからデータを取得してViewModelへ反映
- 更新時にも再取得してViewModelへ反映
- 複雑な監視機構やObservableパターンは使用しない

**具体的な実装：**
1. **表示時の反映**
   - SettingsViewのonAppearでViewModelを初期化
   - ViewModelのgetterでRepository.getSettings()を呼び出し
   - 常に最新のデータを取得

2. **更新時の反映**
   - Pickerで値が変更されるとViewModelのsetterが呼ばれる
   - Repository.updateResetTime()でSwiftDataに保存
   - 次回のgetter呼び出し時に最新値を自動取得

3. **他画面での反映**
   - TodoListViewModelも同じRepositoryを使用
   - performReset()実行時にgetSettings()で最新値を取得
   - 設定変更が自動的に反映される

### 設計の利点

1. **シンプルさ**：
   - 複雑な通知機構が不要
   - データフローが明確で理解しやすい
   - 実装が簡潔

2. **一貫性**：
   - 常にSwiftDataから最新値を取得
   - 複数画面間でのデータ整合性が保証
   - 単一の信頼できるデータソース

3. **テスタビリティ向上**：
   - ViewModelを単体でテストできる
   - MockRepositoryを使った分離テスト
   - UIロジックをテストしやすい

4. **責務分離**：
   - View：UI表示のみ
   - ViewModel：UIロジック、データ変換
   - Repository：データアクセス

5. **拡張性**：
   - 設定画面の複雑なロジックをViewModel内に集約
   - バリデーションやビジネスロジックの追加が容易

6. **保守性**：
   - ViewとRepositoryの結合度が低い
   - 依存性注入でテストしやすい

### 考慮事項

**エッジケース：**
- 設定画面を開いている時にリセット時刻になった場合
  - 発生確率が極めて低いため、現時点では特別な対応は不要
  - ユーザーも「リセット時刻になったから」と理解できる

**パフォーマンス：**
- 毎回SwiftDataアクセスが発生するが、単一レコードのため影響は軽微
- 設定値へのアクセス頻度も低いため、問題にならない

### 破綻する可能性

1. **タイムゾーン対応**が必要になった場合
2. **より細かい時間設定**が必要になった場合（30分単位など）
3. **複数のリセット条件**が必要になった場合
4. **リアルタイムでの設定同期**が必要になった場合（複数デバイス間）

これらの問題に対しても、Repository パターンにより対応しやすい構造になっている。

## 実装計画

このセクションは、リセット時間設定機能の実装計画を記載しています。t-wadaのTDDアプローチ（Red-Green-Refactor）に従い、小さなステップで実装を進めます。

### 実装フェーズ

#### Phase 1: UIプロトタイプ（ステップ0） ✅ **完了**
**目的**: 実際のUIの動きを確認し、ユーザー体験を検証する

0. **SettingsViewのプロトタイプ実装** ✅
   - 仮のPickerUIで0〜23時を選択できるようにする ✅
   - @Stateで状態管理（まだデータ保存はしない） ✅
   - 選択した時間の表示と説明文の確認 ✅
   - TodoListViewからの画面遷移の確認 ✅

**実装内容:**
- SettingsView.swift の新規作成
- 0-23時選択Picker（自然な時間表記: "0:00", "1:00", "23:00"）
- 動的な説明文表示（"毎日X:00に、それより前に作成されたタスクが自動的に削除されます"）
- TodoListViewに歯車アイコンボタン追加（右端配置）
- シートによるモーダル表示で設定画面への遷移

**コミット:** `3087b1a` - リセット時間設定画面のプロトタイプを実装

#### Phase 2: データモデル基盤（ステップ1-2）
**目的**: データの永続化基盤を整備する

1. **Settingsモデルの基本実装とテスト**
   - `@Model`クラスでresetTimeプロパティ（デフォルト0）を実装
   - 単体テストでプロパティの初期値と変更を確認

2. **ModelContainerManagerへの統合**
   - SwiftDataコンテナにSettingsモデルを追加
   - アプリ全体でSettingsが永続化されるように設定

#### Phase 3: 日付判定ロジック（ステップ3-4）
**目的**: リセット時間の判定ロジックを実装する

3. **isBeforeResetTime()の基本実装とテスト**
   - Date拡張に日付判定メソッドを追加
   - 基本的なケース（今日の指定時刻前後）のテスト

4. **isBeforeResetTime()の追加テスト**
   - 日付をまたぐケース（昨日の23時設定で今日の1時など）
   - エッジケース（0時、23時、現在時刻ちょうど）

#### Phase 4: データアクセス層（ステップ5-7）
**目的**: データの読み書きを抽象化する

5. **getSettings()実装とテスト**
   - 設定が存在しない場合はデフォルト値で新規作成
   - 複数回呼び出しても単一インスタンスを返すことを確認

6. **updateResetTime()実装とテスト**
   - 設定値の更新とSwiftDataへの保存
   - 保存後に値が永続化されることを確認

7. **getResetDate()実装とテスト**
   - 今日の指定時刻のDateオブジェクトを返す
   - 各時間（0-23時）での正しい動作を確認

#### Phase 5: ViewModelロジック（ステップ8-9）
**目的**: UIとデータ層を繋ぐビジネスロジックを実装する

8. **SettingsViewModelの基本実装とテスト**
   - resetTimeプロパティのgetter/setter
   - Repositoryとの連携確認（MockRepository使用）

9. **表示用メソッドの実装とテスト**
   - formattedResetTime()（例："06:00"）
   - resetTimeDescription()（説明文生成）

#### Phase 6: UI実装（ステップ10-11）
**目的**: プロトタイプを本実装に置き換える

10. **SettingsViewの本実装**
    - プロトタイプからViewModelを使う実装へ移行
    - Pickerによる0-23時の選択UI
    - NavigationStackとFormによるレイアウト

11. **TodoListViewへの統合**
    - ツールバーに歯車アイコンを追加
    - シートによる設定画面の表示

#### Phase 7: 既存機能との統合（ステップ12-15）
**目的**: 既存のリセット機能を新しい設定に対応させる

12. **TodoListViewModelのコンストラクタ修正**
    - SettingsRepositoryを受け取るように変更
    - 依存性注入の実装

13. **performReset()の修正**
    - isBeforeToday()からisBeforeResetTime()へ切り替え
    - 設定された時間でのリセット動作実装

14. **TodoListViewでの初期化修正**
    - SettingsRepositoryのインスタンス作成
    - ViewModelへの注入

15. **既存テストの修正**
    - MockSettingsRepositoryの作成
    - TodoListViewModelのテストを新しい構造に対応

#### Phase 8: 動作確認（ステップ16-17）
**目的**: 実装の完成度を確認する

16. **iOSシミュレータでの統合テスト**
    - 設定画面での時間変更
    - リセット動作の確認
    - データ永続化の確認

17. **ビルド確認**
    - xcodebuildでエラーがないことを確認
    - 全テストが通ることを確認

### 実装の特徴

- **プロトタイプファースト**: UIの動きを最初に確認してから本実装に入る
- **小さなステップ**: 各機能を細かく分割し、テストで動作を確認しながら進める
- **依存関係の管理**: 下位層（Model、Extensions）から上位層（View）へ順番に実装
- **テストファースト**: 各ステップでテストを先に書いてから実装（TDD）
- **段階的統合**: 新機能を既存コードに少しずつ統合

### 各ステップの見積もり時間

- Phase 1（プロトタイプ）: 30分
- Phase 2-3（基盤実装）: 1時間
- Phase 4-5（ビジネスロジック）: 1.5時間
- Phase 6-7（UI統合）: 1時間
- Phase 8（動作確認）: 30分

合計: 約4時間
